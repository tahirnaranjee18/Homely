@model List<Homely_Web.Models.LeaseModel>
@{
    Layout = "~/Views/Shared/_PropertyManagerLayout.cshtml";
    ViewData["Title"] = "Lease Management";
    var tenants = ViewBag.Tenants as List<Homely_Web.Models.UserModel> ?? new List<Homely_Web.Models.UserModel>();
    var properties = ViewBag.Properties as List<Homely_Web.Models.PropertyModel> ?? new List<Homely_Web.Models.PropertyModel>();
}

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card p-3 shadow-sm border-start border-success border-4">
            <h6 class="text-muted">Active Leases</h6>
            <h3 class="text-success fw-bold">@ViewBag.ActiveLeaseCount</h3>
            <small>Currently occupied properties</small>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card p-3 shadow-sm border-start border-secondary border-4">
            <h6 class="text-muted">Inactive/Expired Leases</h6>
            <h3 class="text-secondary fw-bold">@ViewBag.InactiveLeaseCount</h3>
            <small>Archived or terminated leases</small>
        </div>
    </div>
</div>
<div class="d-flex justify-content-between align-items-center mb-3">
    <form method="get" asp-action="Leases" class="d-flex align-items-center">
        <label class="me-2 fw-semibold">Search:</label>
        <input type="text" name="searchString" class="form-control me-2" placeholder="Tenant or Address..." value="@ViewBag.CurrentSearch" />
        <button type="submit" class="btn btn-secondary">Search</button>
    </form>

    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLeaseModal">
        <i class="fas fa-plus me-2"></i>New Lease
    </button>
</div>

<div class="row">
    <div class="col-md-12">
        @if (Model.Any())
        {
            @foreach (var lease in Model)
            {
                string statusClass = lease.Status == "ACTIVE" ? "bg-success" : "bg-danger";
                <div class="card p-3 mb-3 shadow-sm">
                    <h6>Lease - @lease.PropertyAddress</h6>
                    <p>Tenant: @lease.TenantName | Signed: @lease.FormattedStartDate</p>
                    <p>Status: <span class="badge @statusClass">@lease.Status</span></p>
                    <div>
                        <a href="@lease.LeaseDocumentUrl" class="btn btn-outline-secondary btn-sm" target="_blank">View PDF</a>
                        @if (lease.Status == "ACTIVE")
                        {
                            <button class="btn btn-outline-danger btn-sm" onclick="terminateLease('@lease.Id')">Terminate</button>
                        }
                        else
                        {
                            <button class="btn btn-outline-primary btn-sm" onclick="renewLease('@lease.Id')">Renew</button>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-muted text-center py-5">
                <em>No leases found matching your search.</em>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="addLeaseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Lease</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addLeaseForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label>Select Property</label>
                        <select name="propertyId" class="form-select" required>
                            <option value="">Select...</option>
                            @foreach (var p in properties.Where(prop => !prop.IsRented))
                            {
                                <option value="@p.Id">@p.Title - @p.Location</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Select Tenant</label>
                        <select name="tenantId" class="form-select" required>
                            <option value="">Select...</option>
                            @foreach (var t in tenants)
                            {
                                <option value="@t.Uid">@t.FullName</option>
                            }
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Start Date</label>
                            <input type="date" name="startDate" class="form-control" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>End Date</label>
                            <input type="date" name="endDate" class="form-control" required />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Deposit Amount (R)</label>
                        <input type="text" name="rentAmount" class="form-control" placeholder="e.g., 8000" required />
                    </div>
                    <div class="mb-3">
                        <label>Lease Document (PDF)</label>
                        <input type="file" name="pdfFile" class="form-control" accept="application/pdf" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveLeaseBtn" class_class="btn btn-primary w-100">Save Lease</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById("saveLeaseBtn").addEventListener("click", async function () {
            const form = document.getElementById("addLeaseForm");
            const formData = new FormData(form);
            const response = await fetch("/PropertyManager/AddLease", {
                method: "POST",
                body: formData
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) location.reload();
        });

        async function terminateLease(leaseId) {
            if (!confirm("Are you sure you want to terminate this lease? This will also mark the property as available.")) return;
            const response = await fetch("/PropertyManager/TerminateLease?id=" + leaseId, { method: "POST" });
            const result = await response.json();
            alert(result.message);
            if (result.success) location.reload();
        }

        async function renewLease(leaseId) {
            if (!confirm("Are you sure you want to renew this lease for one year?")) return;
            const response = await fetch("/PropertyManager/RenewLease?id=" + leaseId, { method: "POST" });
            const result = await response.json();
            alert(result.message);
            if (result.success) location.reload();
        }
    </script>
}