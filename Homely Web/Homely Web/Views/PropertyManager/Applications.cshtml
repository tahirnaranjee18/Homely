@model List<Homely_Web.Models.TenantApplicationModel>
@{
    Layout = "~/Views/Shared/_PropertyManagerLayout.cshtml";
    ViewData["Title"] = "Application Review";

    var pending = ViewBag.Pending as List<Homely_Web.Models.TenantApplicationModel> ?? new List<Homely_Web.Models.TenantApplicationModel>();
    var approved = ViewBag.Approved as List<Homely_Web.Models.TenantApplicationModel> ?? new List<Homely_Web.Models.TenantApplicationModel>();
    var rejected = ViewBag.Rejected as List<Homely_Web.Models.TenantApplicationModel> ?? new List<Homely_Web.Models.TenantApplicationModel>();
}

<form method="get" asp-action="Applications" class="mb-3">
    <div class="input-group">
        <input type="text" name="searchString" class="form-control" placeholder="Search by applicant name..." value="@ViewBag.CurrentSearch">
        <button class="btn btn-secondary" type="submit">Search</button>
    </div>
</form>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card p-3 shadow-sm border-start border-warning border-4">
            <h6 class="text-muted">Pending Applications</h6>
            <h3 class="text-warning fw-bold">@pending.Count</h3>
            <small>Awaiting your review</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 shadow-sm border-start border-success border-4">
            <h6 class="text-muted">Approved Applications</h6>
            <h3 class="text-success fw-bold">@approved.Count</h3>
            <small>Ready for lease creation</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 shadow-sm border-start border-danger border-4">
            <h6 class="text-muted">Rejected Applications</h6>
            <h3 class="text-danger fw-bold">@rejected.Count</h3>
            <small>Archived</small>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-md-4">
        <h5 class="fw-semibold mb-3">Pending Review</h5>
        @if (pending.Any())
        {
            @foreach (var app in pending)
            {
                <div class="card mb-3 shadow-sm p-3">
                    <h6 class="fw-bold">@app.ApplicantName</h6>

                    <p class="text-muted small">
                        Applied for: @app.PropertyName <br />
                        Submitted: @app.Timestamp.ToDateTime().ToString("dd MMM yyyy")
                    </p>

                    <div class="d-flex gap-2 mt-2">
                        <a href="@app.IdUrl" class="btn btn-sm btn-outline-secondary" target="_blank">
                            <i class="fas fa-id-card me-1"></i> View ID
                        </a>
                        <a href="@app.PayslipUrl" class="btn btn-sm btn-outline-secondary" target="_blank">
                            <i class="fas fa-file-invoice me-1"></i> View Payslip
                        </a>
                    </div>

                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-sm btn-success" onclick="approve('@app.Id')">Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="reject('@app.Id')">Reject</button>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-muted"><em>No pending applications.</em></p>
        }
    </div>


    <div class="col-md-4">
        <h5 class="fw-semibold mb-3">Approved</h5>
        @if (approved.Any())
        {
            @foreach (var app in approved)
            {
                <div class="card mb-3 p-3 shadow-sm border-success">
                    <h6 class="fw-bold">@app.ApplicantName</h6>
                    <p class="text-muted small">Property: @app.PropertyName</p>
                    <span class="badge bg-success">Approved</span>
                </div>
            }
        }
        else
        {
            <p class="text-muted"><em>No approved applications.</em></p>
        }
    </div>


    <div class="col-md-4">
        <h5 class="fw-semibold mb-3">Rejected</h5>
        @if (rejected.Any())
        {
            @foreach (var app in rejected)
            {
                <div class="card mb-3 p-3 shadow-sm border-danger">
                    <h6 class="fw-bold">@app.ApplicantName</h6>
                    <p class="text-muted small">Property: @app.PropertyName</p>
                    <span class="badge bg-danger">Rejected</span>
                </div>
            }
        }
        else
        {
            <p class="text-muted"><em>No rejected applications.</em></p>
        }
    </div>
</div>

@section Scripts {
    <script>
        async function approve(id) {
            if (!confirm("Are you sure you want to approve this application?")) return;

            const res = await fetch("/PropertyManager/ApproveApplication?id=" + id, { method: "POST" });
            const result = await res.json();
            alert(result.message);
            if (result.success) location.reload();
        }

        async function reject(id) {
            if (!confirm("Are you sure you want to reject this application?")) return;

            const res = await fetch("/PropertyManager/RejectApplication?id=" + id, { method: "POST" });
            const result = await res.json();
            alert(result.message);
            if (result.success) location.reload();
        }
    </script>
}