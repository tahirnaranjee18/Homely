@model Homely_Web.Models.PropertyModel

@{
    Layout = "~/Views/Shared/_PropertyManagerLayout.cshtml";
    ViewData["Title"] = Model.Title;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div></div>
        <a href="/PropertyManager/Properties" class="btn btn-secondary">← Back to Listings</a>
    </div>

    <div class="row align-items-stretch">
        <div class="col-md-5">
            <img src="@Model.DisplayImage" alt="@Model.Title" class="img-fluid rounded shadow-sm h-100" style="object-fit:cover;" />
        </div>

        <div class="col-md-7">
            <div class="card shadow-sm p-4 h-100">
                <h4 class="mb-3">Property Information</h4>
                <p><strong>Location:</strong> @Model.Location</p>
                <p><strong>Status:</strong> @(Model.IsRented ? "Occupied" : "Available")</p>
                <p><strong>Price:</strong> R @Model.Price / month</p>
                <p><strong>Lease:</strong> @Model.LeaseDuration months</p>
                <hr />
                <p>
                    <i class="fas fa-bed me-2"></i> @Model.Bedrooms Bedrooms
                    <i class="fas fa-bath me-2 ms-3"></i> @Model.Bathrooms Bathrooms
                    <i class="fas fa-car me-2 ms-3"></i> @Model.Garages Garages
                </p>

                <div class="flex-grow-1"></div>

                <div class="mt-4 d-flex gap-2">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editPropertyModal">Edit</button>
                    <button class="btn btn-outline-danger" onclick="deleteProperty('@Model.Id')">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editPropertyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Property</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPropertyForm" enctype="multipart/form-data">
                    <input type="hidden" name="id" value="@Model.Id" />

                    <div class="mb-3">
                        <label>Property Title</label>
                        <input type="text" name="title" class="form-control" value="@Model.Title" required />
                    </div>
                    <div class="mb-3">
                        <label>Location (Address)</label>
                        <input type="text" name="location" class="form-control" value="@Model.Location" required />
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Price (R)</label>
                            <input type="text" name="price" class="form-control" value="@Model.Price" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Lease Duration (Months)</label>
                            <input type="text" name="leaseDuration" class="form-control" value="@Model.LeaseDuration" required />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>Bedrooms</label>
                            <input type="number" name="bedrooms" class="form-control" value="@Model.Bedrooms" required />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>Bathrooms</label>
                            <input type="number" name="bathrooms" class="form-control" value="@Model.Bathrooms" required />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>Garages</label>
                            <input type="number" name="garages" class="form-control" value="@Model.Garages" required />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label>Change Property Image (Optional)</label>
                        <input type="file" name="image" accept="image/*" class="form-control" onchange="previewEditImage(event)" />
                        <img id="imageEditPreview" src="@Model.DisplayImage" alt="Preview" class="mt-3 rounded" style="width:100%; height:200px; object-fit:cover;" />
                    </div>
                    <button type="button" id="saveEditBtn" class="btn btn-primary w-100">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function previewEditImage(event) {
            const preview = document.getElementById("imageEditPreview");
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => { preview.src = e.target.result; };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById("saveEditBtn").addEventListener("click", async function () {
            const form = document.getElementById("editPropertyForm");
            const formData = new FormData(form);

            const response = await fetch("/PropertyManager/EditProperty", {
                method: "POST",
                body: formData
            });

            const result = await response.json();
            alert(result.message);
            if (result.success) location.reload();
        });

        async function deleteProperty(id) {
            if (!confirm("Are you sure you want to delete this property?")) return;

            const response = await fetch("/PropertyManager/DeleteProperty?id=" + id, { method: "POST" });
            const result = await response.json();

            alert(result.message);
            if (result.success) window.location.href = "/PropertyManager/Properties";
        }
    </script>
}